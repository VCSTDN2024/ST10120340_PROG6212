@model ContractMonthlyClaimSystem.ViewModels.SubmitClaimViewModel

@{
    ViewData["Title"] = "Submit Claim";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h2><i class="fas fa-file-invoice"></i> Submit New Claim</h2>
                </div>
                <div class="card-body">

                    @* Success Message *@
                    @if (TempData["SuccessMessage"] != null)
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <i class="fas fa-check-circle"></i> @TempData["SuccessMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }

                    <form asp-action="SubmitClaim" method="post" enctype="multipart/form-data" id="claimForm">
                        <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                        <div class="mb-3">
                            <label asp-for="HoursWorked" class="form-label">Hours Worked</label>
                            <input asp-for="HoursWorked" class="form-control" id="hoursWorked" type="number" step="0.01"
                                   placeholder="Enter hours worked" />
                            <small class="form-text text-muted">Maximum 744 hours per month</small>
                            <span asp-validation-for="HoursWorked" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="HourlyRate" class="form-label">Hourly Rate (R)</label>
                            <input asp-for="HourlyRate" class="form-control" id="hourlyRate" type="number" step="0.01"
                                   placeholder="Enter hourly rate" />
                            <small class="form-text text-muted">Rate must be between R50 and R10,000</small>
                            <span asp-validation-for="HourlyRate" class="text-danger"></span>
                        </div>

                        @* ===== PART 3: AUTO-CALCULATED TOTAL AMOUNT ===== *@
                        <div class="mb-3">
                            <label class="form-label">Total Amount (Auto-Calculated)</label>
                            <div class="input-group input-group-lg">
                                <span class="input-group-text bg-success text-white">R</span>
                                <input type="text" class="form-control bg-light fw-bold text-success" id="totalAmount"
                                       readonly value="0.00" style="font-size: 1.5rem;" />
                            </div>
                            <small class="form-text text-info">
                                <i class="fas fa-info-circle"></i> This amount is automatically calculated as Hours × Rate
                            </small>
                        </div>

                        <div class="mb-3">
                            <label asp-for="AdditionalNotes" class="form-label">Additional Notes (Optional)</label>
                            <textarea asp-for="AdditionalNotes" class="form-control" rows="3"
                                      placeholder="Any additional information about this claim"></textarea>
                            <span asp-validation-for="AdditionalNotes" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="SupportingDocument" class="form-label">
                                Supporting Document <span class="text-danger">*</span>
                            </label>
                            <input asp-for="SupportingDocument" class="form-control" id="documentFile" type="file"
                                   accept=".pdf,.jpg,.jpeg,.png,.docx,.xlsx" />
                            <small class="form-text text-muted">
                                Allowed: PDF, JPG, PNG, DOCX, XLSX (Max 5MB)
                            </small>
                            <span asp-validation-for="SupportingDocument" class="text-danger"></span>
                        </div>

                        @* ===== PART 3: VALIDATION CHECKS DISPLAY ===== *@
                        <div class="alert alert-info">
                            <h6><i class="fas fa-clipboard-check"></i> Validation Checks:</h6>
                            <ul id="validationChecks" class="mb-0">
                                <li id="check1">Hours worked: <span class="badge bg-secondary">Not checked</span></li>
                                <li id="check2">Hourly rate: <span class="badge bg-secondary">Not checked</span></li>
                                <li id="check3">Total amount: <span class="badge bg-secondary">Not checked</span></li>
                                <li id="check4">Document: <span class="badge bg-secondary">Not checked</span></li>
                            </ul>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                                <i class="fas fa-paper-plane"></i> Submit Claim
                            </button>
                            <a asp-action="Index" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        // ===== PART 3: AUTO-CALCULATION FEATURE =====
        function calculateTotalAmount() {
            const hoursWorked = parseFloat($('#hoursWorked').val()) || 0;
            const hourlyRate = parseFloat($('#hourlyRate').val()) || 0;
            const totalAmount = hoursWorked * hourlyRate;

            // Update display with currency formatting
            $('#totalAmount').val(totalAmount.toFixed(2));

            // Perform validation checks
            validateClaim(hoursWorked, hourlyRate, totalAmount);
        }

        // ===== PART 3: REAL-TIME VALIDATION CHECKS =====
        function validateClaim(hours, rate, total) {
            let allValid = true;

            // Check 1: Hours worked validation (0.01-744)
            if (hours >= 0.01 && hours <= 744) {
                $('#check1').html('Hours worked: <span class="badge bg-success">✓ Valid (0.01-744)</span>');
            } else if (hours > 0) {
                $('#check1').html('Hours worked: <span class="badge bg-danger">✗ Invalid (must be 0.01-744)</span>');
                allValid = false;
            } else {
                $('#check1').html('Hours worked: <span class="badge bg-secondary">Not entered</span>');
                allValid = false;
            }

            // Check 2: Hourly rate validation (R50-R10,000)
            if (rate >= 50 && rate <= 10000) {
                $('#check2').html('Hourly rate: <span class="badge bg-success">✓ Valid (R50-R10,000)</span>');
            } else if (rate > 0) {
                $('#check2').html('Hourly rate: <span class="badge bg-danger">✗ Invalid (must be R50-R10,000)</span>');
                allValid = false;
            } else {
                $('#check2').html('Hourly rate: <span class="badge bg-secondary">Not entered</span>');
                allValid = false;
            }

            // Check 3: Total amount validation (max R500,000)
            if (total > 0 && total <= 500000) {
                $('#check3').html('Total amount: <span class="badge bg-success">✓ Valid (≤R500,000)</span>');
            } else if (total > 500000) {
                $('#check3').html('Total amount: <span class="badge bg-danger">✗ Exceeds R500,000 threshold</span>');
                allValid = false;
            } else {
                $('#check3').html('Total amount: <span class="badge bg-secondary">Not calculated</span>');
                allValid = false;
            }

            // Check 4: Document validation
            const documentFile = $('#documentFile')[0].files[0];
            if (documentFile) {
                const fileSize = documentFile.size / 1024 / 1024; // Convert to MB
                const allowedTypes = ['.pdf', '.docx', '.xlsx', '.jpg', '.jpeg', '.png'];
                const fileExt = '.' + documentFile.name.split('.').pop().toLowerCase();

                if (allowedTypes.includes(fileExt) && fileSize <= 5) {
                    $('#check4').html('Document: <span class="badge bg-success">✓ Valid (' + documentFile.name + ')</span>');
                } else if (fileSize > 5) {
                    $('#check4').html('Document: <span class="badge bg-danger">✗ File too large (>5MB)</span>');
                    allValid = false;
                } else {
                    $('#check4').html('Document: <span class="badge bg-danger">✗ Invalid file type</span>');
                    allValid = false;
                }
            } else {
                $('#check4').html('Document: <span class="badge bg-warning">⚠ Recommended</span>');
                // Don't block submission if document is optional in your system
            }

            // Enable/disable submit button based on validation
            $('#submitBtn').prop('disabled', !allValid);
        }

        // ===== EVENT LISTENERS FOR REAL-TIME UPDATES =====
        $(document).ready(function() {
            // Calculate on input change
            $('#hoursWorked, #hourlyRate').on('input', function() {
                calculateTotalAmount();
            });

            // Validate document on file selection
            $('#documentFile').on('change', function() {
                validateClaim(
                    parseFloat($('#hoursWorked').val()) || 0,
                    parseFloat($('#hourlyRate').val()) || 0,
                    parseFloat($('#totalAmount').val()) || 0
                );
            });

            // Initial validation check
            calculateTotalAmount();
        });

        // ===== FORM SUBMISSION CONFIRMATION =====
        $('#claimForm').on('submit', function(e) {
            const totalAmount = parseFloat($('#totalAmount').val());
            if (totalAmount > 0) {
                return confirm('You are about to submit a claim for R' + totalAmount.toFixed(2) + '. Continue?');
            }
            return true;
        });
    </script>

    <style>
        .card {
            border: none;
            border-radius: 10px;
        }

        .card-header {
            border-radius: 10px 10px 0 0 !important;
        }

        #totalAmount {
            border: 2px solid #28a745;
        }

        .form-label {
            font-weight: 600;
        }

        #validationChecks li {
            margin-bottom: 5px;
        }
    </style>
}